{% extends 'base.html' %}

{% block title %}{{ product.name }} - Kayaba≈üƒ± Naturel{% endblock %}

{% block content %}
<div class="container" style="margin-top: 80px; margin-bottom: 80px;">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'store:index' %}">Ana Sayfa</a></li>
            {% if product.category %}
                <li class="breadcrumb-item">{{ product.category.name }}</li>
            {% endif %}
            <li class="breadcrumb-item active">{{ product.name }}</li>
        </ol>
    </nav>

    <div class="row g-4">
        <!-- √úr√ºn Galerisi -->
        <div class="col-lg-6">
            <!-- Ana Resim -->
            <div class="card shadow-sm border-0 mb-3">
                <img id="mainImage" src="{% if product.image %}{{ product.image.url }}{% else %}https://placehold.co/600x600?text=√úr√ºn+G√∂rseli{% endif %}" 
                     class="card-img-top" alt="{{ product.name }}" style="border-radius: 8px; object-fit: cover; height: 500px;">
            </div>

            <!-- K√º√ß√ºk Resimler (Galeri) -->
            {% if product.images.all %}
                <div class="row g-2">
                    <!-- Ana √ºr√ºn resmi thumbnail -->
                    <div class="col-3">
                        <img src="{% if product.image %}{{ product.image.url }}{% else %}https://placehold.co/100x100{% endif %}" 
                             alt="{{ product.name }}" class="img-thumbnail cursor-pointer" 
                             onclick="document.getElementById('mainImage').src=this.src;"
                             style="cursor: pointer; border: 2px solid #28a745;">
                    </div>
                    <!-- Ek resimler -->
                    {% for img in product.images.all %}
                        <div class="col-3">
                            <img src="{{ img.image.url }}" alt="{{ img.alt_text }}" 
                                 class="img-thumbnail cursor-pointer" 
                                 onclick="document.getElementById('mainImage').src=this.src;"
                                 style="cursor: pointer;">
                        </div>
                    {% endfor %}
                </div>
            {% endif %}
        </div>

        <!-- √úr√ºn Bilgileri -->
        <div class="col-lg-6">
            <!-- Ba≈ülƒ±k -->
            <h1 class="mb-3">{{ product.name }}</h1>
            
            <!-- Rating -->
            {% if avg_rating %}
                <div class="mb-3">
                    <div style="color: #ffc107; font-size: 18px;">
                        {% for i in "12345" %}
                            {% if i|add:0 <= avg_rating|floatformat:0 %}‚≠ê{% else %}‚òÜ{% endif %}
                        {% endfor %}
                    </div>
                    <small class="text-success">Ort. {{ avg_rating|floatformat:1 }}/5 ({{ review_count }} yorum)</small>
                </div>
            {% else %}
                <p class="text-muted mb-3">Hen√ºz yorum yok</p>
            {% endif %}

            <!-- Fiyat -->
            <h3 class="text-success fw-bold mb-3">{{ product.price|floatformat:2 }} TL</h3>

            <!-- Stok -->
            <div class="mb-4">
                {% if product.stock > 0 %}
                    {% if product.stock < 10 %}
                        <div class="alert alert-warning mb-0">
                            <strong>‚ö†Ô∏è Son {{ product.stock }} √ºr√ºn kaldƒ±!</strong>
                        </div>
                    {% else %}
                        <span class="badge bg-success">‚úì Stokta Var</span>
                    {% endif %}
                {% else %}
                    <div class="alert alert-danger mb-0">
                        <strong>Maalesef Stokta Yok</strong>
                    </div>
                {% endif %}
            </div>

            <!-- Sepete Ekle -->
            <div class="mb-4">
                {% if product.stock > 0 %}
                    <form method="POST" action="{% url 'store:add_to_cart' product.slug %}">
                        {% csrf_token %}
                        <div class="row g-2 mb-3">
                            <div class="col-md-4">
                                <label class="form-label fw-bold">Miktar
                                    {% if default_min_amount %}
                                        <small class="text-muted">(minimum <span id="minHint">{{ default_min_amount }} {{ product.unit }}</span>)</small>
                                    {% endif %}
                                </label>
                                <input type="number" id="quantityInput" name="quantity" value="1" min="{% if default_min_amount %}{{ default_min_amount }}{% else %}1{% endif %}" class="form-control">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label fw-bold">√ñl√ß√º Birimi</label>
                                <select name="unit" id="unitSelect" class="form-select" required>
                                    <option value="">Se√ßin</option>
                                    {% for unit_value, unit_label in selectable_units %}
                                        <option value="{{ unit_value }}" {% if product.unit == unit_value %}selected{% endif %}>{{ unit_label }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-4 d-flex align-items-end">
                                <button class="btn btn-success w-100" type="submit">
                                    <i class="fas fa-shopping-cart"></i> Sepete Ekle
                                </button>
                            </div>
                        </div>
                    </form>
                {% else %}
                    <button class="btn btn-secondary btn-lg w-100" disabled>Stokta Yok</button>
                {% endif %}
            </div>

            <!-- √ñzellikleri -->
            <div class="card border-0 bg-light">
                <div class="card-body">
                    <h6 class="card-title mb-3"><strong>üìã √úr√ºn √ñzellikleri</strong></h6>
                    <dl class="row mb-0">
                        {% if product.weight %}
                            <dt class="col-sm-4">Net Aƒüƒ±rlƒ±k:</dt>
                            <dd class="col-sm-8">{{ product.weight }}</dd>
                        {% endif %}
                        {% if product.production_location %}
                            <dt class="col-sm-4">√úretim Yeri:</dt>
                            <dd class="col-sm-8">{{ product.production_location }}</dd>
                        {% endif %}
                        {% if product.shelf_life %}
                            <dt class="col-sm-4">Raf √ñmr√º:</dt>
                            <dd class="col-sm-8">{{ product.shelf_life }}</dd>
                        {% endif %}
                    </dl>
                </div>
            </div>
        </div>
    </div>

    <!-- Detaylƒ± Bilgiler -->
    <div class="row mt-5">
        <div class="col-lg-8">
            {% if product.description %}
                <h3 class="mb-3">üìù A√ßƒ±klama</h3>
                <p>{{ product.description|linebreaks }}</p>
            {% endif %}

            {% if product.ingredients %}
                <h4 class="mt-4 mb-3">ü•Ñ ƒ∞√ßerik Bilgisi</h4>
                <p>{{ product.ingredients|linebreaks }}</p>
            {% endif %}

            {% if product.production_process %}
                <h4 class="mt-4 mb-3">‚öôÔ∏è √úretim S√ºreci</h4>
                <p>{{ product.production_process|linebreaks }}</p>
            {% endif %}

            {% if product.storage_conditions %}
                <h4 class="mt-4 mb-3">üßä Saklama Ko≈üullarƒ±</h4>
                <p>{{ product.storage_conditions|linebreaks }}</p>
            {% endif %}
        </div>
    </div>

    <!-- Yorumlar B√∂l√ºm√º -->
    <div class="row mt-5">
        <div class="col-lg-8">
            <h3 class="mb-4">‚≠ê M√º≈üteri Yorumlarƒ±</h3>

            {% if reviews %}
                {% for review in reviews %}
                    <div class="card mb-3 border-0 shadow-sm">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <div>
                                    <h6 class="mb-1">{{ review.user.get_full_name|default:review.user.username }}</h6>
                                    <small class="text-warning">
                                        {% for i in "12345" %}
                                            {% if i|add:0 <= review.rating %}‚≠ê{% else %}‚òÜ{% endif %}
                                        {% endfor %}
                                    </small>
                                </div>
                                <small class="text-muted">{{ review.created_at|date:"d.m.Y" }}</small>
                            </div>
                            <h6 class="mb-2">{{ review.title }}</h6>
                            <p class="mb-0">{{ review.comment }}</p>
                        </div>
                    </div>
                {% endfor %}
            {% else %}
                <div class="alert alert-info">
                    Hen√ºz bu √ºr√ºn i√ßin yorum yapƒ±lmamƒ±≈ü.
                </div>
            {% endif %}

            <!-- Yorum Formu -->
            {% if user.is_authenticated %}
                <h4 class="mt-4 mb-3">Yorum Yap</h4>
                <form method="post" class="card border-0 bg-light p-3">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label class="form-label">Puan</label>
                        <select name="rating" class="form-select" required>
                            <option value="">Puan Se√ßin</option>
                            <option value="5">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê 5 Yƒ±ldƒ±z</option>
                            <option value="4">‚≠ê‚≠ê‚≠ê‚≠ê 4 Yƒ±ldƒ±z</option>
                            <option value="3">‚≠ê‚≠ê‚≠ê 3 Yƒ±ldƒ±z</option>
                            <option value="2">‚≠ê‚≠ê 2 Yƒ±ldƒ±z</option>
                            <option value="1">‚≠ê 1 Yƒ±ldƒ±z</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Ba≈ülƒ±k</label>
                        <input type="text" name="title" class="form-control" placeholder="Yorum ba≈ülƒ±ƒüƒ±" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Yorum</label>
                        <textarea name="comment" class="form-control" rows="4" placeholder="Detaylƒ± yorum yapƒ±n..." required></textarea>
                    </div>
                    <button type="submit" class="btn btn-success">Yorumu Yayƒ±nla</button>
                </form>
            {% else %}
                <div class="alert alert-warning">
                    Yorum yapmak i√ßin <a href="{% url 'store:login' %}">giri≈ü yap</a>.
                </div>
            {% endif %}
        </div>
    </div>
</div>
<script>
    (function() {
        var minMap = {{ min_order_amounts|default:'{}'|safe }};
        var unitSelect = document.getElementById('unitSelect');
        var qtyInput = document.getElementById('quantityInput');
        var minHint = document.getElementById('minHint');
        function updateMin() {
            if (!unitSelect || !qtyInput) return;
            var u = unitSelect.value || '{{ product.unit }}';
            var m = minMap && minMap[u] ? parseInt(minMap[u]) : 1;
            qtyInput.min = m;
            if (qtyInput.value < m) { qtyInput.value = m; }
            if (minHint) { minHint.textContent = m + ' ' + u; }
        }
        if (unitSelect) {
            unitSelect.addEventListener('change', updateMin);
            updateMin();
        }
    })();
</script>
{% endblock %}
